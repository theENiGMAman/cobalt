<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Darty â€” Scientist Runner</title>
<style>
  body {
    margin: 0;
    background: #000;
    color: #0f0;
    font-family: monospace;
    overflow: hidden;
    user-select: none;
  }
  canvas {
    display: block;
    margin: 0 auto;
    background: #000;
  }
  #score {
    position: absolute;
    bottom: 10px;
    left: 49%;
    transform: translateX(-50%);
    color: #0f0;
    font-size: 20px;
  }

  /* Retro game over popup */
  #gameOverBox {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(200, 0, 0, 0.8);
    color: #fff;
    border: 2px solid #f00;
    padding: 20px;
    text-align: center;
    font-family: monospace;
    display: none;
    box-shadow: 0 0 20px red;
  }
  #gameOverBox button {
    background: #000;
    border: 1px solid #f00;
    color: #f00;
    font-family: monospace;
    padding: 5px 10px;
    margin: 8px;
    cursor: pointer;
  }
  #gameOverBox button:hover {
    background: #f00;
    color: #000;
  }

  /* Win popup */
  #winBox {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 200, 0, 0.85);
    color: #0f0;
    border: 2px solid #0f0;
    padding: 20px;
    text-align: center;
    font-family: monospace;
    display: none;
    box-shadow: 0 0 20px #0f0;
  }
  #winBox button {
    background: #000;
    border: 1px solid #0f0;
    color: #0f0;
    font-family: monospace;
    padding: 5px 10px;
    margin: 8px;
    cursor: pointer;
  }
  #winBox button:hover {
    background: #0f0;
    color: #000;
  }
</style>

<link rel="stylesheet" href="styles.css" />

<audio id="clickSound" src="sfx/click.mp3" preload="auto"></audio>
<audio id="openSound" src="sfx/open.mp3" preload="auto"></audio>
<audio id="closeSound" src="sfx/close.mp3" preload="auto"></audio>

<script>
  const clickSound = document.getElementById('clickSound');
  const openSound  = document.getElementById('openSound');
  const closeSound = document.getElementById('closeSound');

  // Play click sound for every click on the page
  document.addEventListener('click', () => {
    clickSound.currentTime = 0;
    clickSound.play().catch(()=>{});
  });

  // Patch openMessage and closeOverlay to add sounds
  (function(){
    const origOpenMessage = window.openMessage;
    const origCloseOverlay = window.closeOverlay;

    // Re-declare functions in global scope
    window.openMessage = function(id){
      openSound.currentTime = 0;
      openSound.play().catch(()=>{});
      if (origOpenMessage) origOpenMessage(id);
    };

    window.closeOverlay = function(){
      closeSound.currentTime = 0;
      closeSound.play().catch(()=>{});
      if (origCloseOverlay) origCloseOverlay();
    };
  })();
</script>
</head>
<body>

<audio id="bgm" src="sfx/arcade.mp3" loop preload="auto"></audio>
<audio id="jumpSFX" src="sfx/jump_1.wav" preload="auto"></audio>
<audio id="pickupSFX" src="sfx/pickup_3.wav" preload="auto"></audio>
<audio id="deathSFX" src="sfx/error_2.wav" preload="auto"></audio>

<!-- CRT frame overlay -->
<img class="crt-frame" src="img/crt_green_mask.png" alt="CRT Frame" />

<!-- Hidden SVG filters -->
<div style="display:none; position:absolute; top:-9999px;">
  <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="svg-root" width="0" height="0">
    <defs>
      <!-- Barrel distortion -->
      <filter id="SphereMapTest" filterUnits="objectBoundingBox" x="-0.45" y="-1.29" width="1.6" height="3.5">
        <feImage id="mapa" result="Map" xlink:href="https://chafalleiro.github.io/retromator/img/sphere_wide_1.png" />
        <feDisplacementMap id="despMap" in="SourceGraphic" in2="map" scale="100" xChannelSelector="R" yChannelSelector="G" />
      </filter>

      <!-- Brightness / contrast (optional tweak) -->
      <filter id="contrast">
        <feComponentTransfer>
          <feFuncR type="linear" slope="1" intercept="0"/>
          <feFuncG type="linear" slope="1" intercept="0"/>
          <feFuncB type="linear" slope="1" intercept="0"/>
        </feComponentTransfer>
      </filter>
      <filter id="brightness">
        <feComponentTransfer>
          <feFuncR type="linear" slope="1"/>
          <feFuncG type="linear" slope="1"/>
          <feFuncB type="linear" slope="1"/>
        </feComponentTransfer>
      </filter>
    </defs>
  </svg>
</div>

<script src="sound.js"></script>
  <div class="noise"></div>
<!-- CRT container -->
<div id="crtContainer" class="crt-container">
  <div class="scan-line"></div>
  <div class="distort-overlay"></div>
  
  <div id="custom-cursor"></div>
  <div class="container">
    <div class="frame">
      <div class="screen crt" id="screen">
        <pre style="font-family: monospace; font-size: 14px;">
		<pre style="font-family: monospace; line-height: 1; font-size: 14px;">
__/\\\\\\\\\\\\________/\\\\\\\\\_______/\\\\\\\\\______/\\\\\\\\\\\\\\\__/\\\________/\\\_        
 _\/\\\////////\\\____/\\\\\\\\\\\\\___/\\\///////\\\___\///////\\\/////__\///\\\____/\\\/__       
  _\/\\\______\//\\\__/\\\/////////\\\_\/\\\_____\/\\\_________\/\\\_________\///\\\/\\\/____      
   _\/\\\_______\/\\\_\/\\\_______\/\\\_\/\\\\\\\\\\\/__________\/\\\___________\///\\\/______     
    _\/\\\_______\/\\\_\/\\\\\\\\\\\\\\\_\/\\\//////\\\__________\/\\\_____________\/\\\_______    
     _\/\\\_______\/\\\_\/\\\/////////\\\_\/\\\____\//\\\_________\/\\\_____________\/\\\_______   
      _\/\\\_______/\\\__\/\\\_______\/\\\_\/\\\_____\//\\\________\/\\\_____________\/\\\_______  
       _\/\\\\\\\\\\\\/___\/\\\_______\/\\\_\/\\\______\//\\\_______\/\\\_____________\/\\\_______ 
        _\////////////_____\///________\///__\///________\///________\///______________\///________

DARTY - THE SCIENTIST RUN GAME
Created by TEAM SRC.
<div id="score">Score: 0</div>
<canvas id="gameCanvas" width="800" height="200"></canvas>

<!-- Game Over Popup -->
<div id="gameOverBox">
  <h2>!!! SYSTEM FAILURE !!!</h2>
  <p id="finalScore">Score: 0</p>
  <button onclick="restartGame()">PLAY AGAIN</button>
  <button onclick="window.location.href='index.html'">BACK TO TERMINAL</button>
</div>

<!-- Win Popup -->
<div id="winBox">
  <h2>*** ACCESS GRANTED ***</h2>
  <p>You reached 10,000 points!</p>
  <p>Your 4-digit override code is: <span id="winCode"></span></p>
  <button onclick="restartGame()">PLAY AGAIN</button>
  <button onclick="window.location.href='index.html'">BACK TO TERMINAL</button>
</div>
        </pre>
      </div>
    </div>
  </div>
</div>
<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// --- AUDIO ELEMENTS ---
const bgm = new Audio('sfx/arcade.mp3'); bgm.loop = true; bgm.volume = 0.4;
const jumpSFX = new Audio('sfx/jump_1.wav'); jumpSFX.volume = 0.8;
const pickupSFX = new Audio('sfx/pickup_3.wav'); pickupSFX.volume = 0.8;
const deathSFX = new Audio('sfx/error_2.wav'); deathSFX.volume = 0.8;

// --- GAME VARIABLES ---
let gameSpeed, gravity, score, frameCount, gameRunning;
let obstacles = [], flasks = [], birds = [];

// Minimum and maximum horizontal spacing
const minSpacing = 40;
const maxSpacing = 120;
const birdChance = 0.3; // Red squares less frequent

let nextObstacleIn, nextBirdIn, nextFlaskIn;

// Utility function for random int
function randomInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

// --- PLAYER ---
const player = {
  x: 50, y: 150, width: 20, height: 20, dy: 0, jumping: false,
  draw() {
    ctx.fillStyle = "#0f0";
    ctx.fillRect(this.x, this.y, this.width, this.height);
    ctx.fillRect(this.x + 4, this.y - 10, 12, 10);
    ctx.fillStyle = "#000";
    ctx.fillRect(this.x + 6, this.y - 6, 3, 3);
    ctx.fillRect(this.x + 11, this.y - 6, 3, 3);
    ctx.fillStyle = "#0f0";
    ctx.fillRect(this.x - 4, this.y + 4, 4, 4);
    ctx.fillRect(this.x + this.width, this.y + 4, 4, 4);
    ctx.fillRect(this.x + 3, this.y + this.height, 5, 5);
    ctx.fillRect(this.x + 12, this.y + this.height, 5, 5);
  },
  jump() {
    if (!this.jumping) {
      this.dy = -12;
      this.jumping = true;
      // Play jump SFX
      jumpSFX.currentTime = 0;
      jumpSFX.play().catch(()=>{});
    }
  },
  update() {
    this.y += this.dy;
    if (this.y + this.height < canvas.height) this.dy += gravity;
    else { this.dy = 0; this.y = canvas.height - this.height; this.jumping = false; }
    this.draw();
  }
};

// --- INIT GAME ---
function initGame() {
  gameSpeed = 4;
  gravity = 1;
  score = 0;
  frameCount = 0;
  gameRunning = true;
  obstacles = [];
  flasks = [];
  birds = [];
  player.y = 150;
  player.dy = 0;
  document.getElementById("score").innerText = "Score: 0";
  document.getElementById("gameOverBox").style.display = "none";
  document.getElementById("winBox").style.display = "none";

  nextObstacleIn = randomInt(minSpacing, maxSpacing);
  nextBirdIn = randomInt(minSpacing*2, maxSpacing*2);
  nextFlaskIn = randomInt(100, 250);

  // Start BGM
  bgm.currentTime = 0;
  bgm.play().catch(()=>{});

  requestAnimationFrame(gameLoop);
}

// --- SPAWN ---
function spawnObstacle() {
  obstacles.push({ x: canvas.width, y: canvas.height - 20, width: 20, height: 20 });
  nextObstacleIn = randomInt(minSpacing, maxSpacing);
}
function spawnFlask() {
  flasks.push({ x: canvas.width, y: canvas.height - 25, width: 10, height: 10 });
  nextFlaskIn = randomInt(100, 250);
}
function spawnBird() {
  if (Math.random() < birdChance) {
    const heights = [80, 100, 120];
    birds.push({ x: canvas.width, y: heights[Math.floor(Math.random() * heights.length)], width: 20, height: 20 });
  }
  nextBirdIn = randomInt(minSpacing*2, maxSpacing*2);
}

// --- COLLISION CHECK ---
function colliding(a, b) {
  return a.x < b.x + b.width && a.x + a.width > b.x &&
         a.y < b.y + b.height && a.y + a.height > b.y;
}

// --- GAME OVER ---
function gameOver() {
  if (!gameRunning) return;
  gameRunning = false;
  // Play death SFX
  deathSFX.currentTime = 0;
  deathSFX.play().catch(()=>{});
  // Stop BGM
  bgm.pause();
  document.getElementById("finalScore").innerText = "Score: " + score;
  document.getElementById("gameOverBox").style.display = "block";
}

// --- WIN ---
function winGame() {
  if (!gameRunning) return;
  gameRunning = false;
  bgm.pause();
  const code = 8989;
  document.getElementById("winCode").innerText = code;
  document.getElementById("winBox").style.display = "block";
}

// --- GAME LOOP ---
function gameLoop() {
  if (!gameRunning) return;

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  frameCount++;
  if (frameCount % 300 === 0) gameSpeed += 0.5;

  // Spawn logic
  nextObstacleIn--; if (nextObstacleIn <= 0) spawnObstacle();
  nextBirdIn--; if (nextBirdIn <= 0) spawnBird();
  nextFlaskIn--; if (nextFlaskIn <= 0) spawnFlask();

  // Obstacles
  obstacles.forEach((o, i) => {
    o.x -= gameSpeed;
    ctx.fillStyle = "#fff";
    ctx.fillRect(o.x, o.y, o.width, o.height);
    if (colliding(player, o)) gameOver();
    if (o.x + o.width < 0) obstacles.splice(i, 1);
  });

  // Flasks
  flasks.forEach((f, i) => {
    f.x -= gameSpeed;
    ctx.fillStyle = "#0f0";
    ctx.beginPath();
    ctx.moveTo(f.x, f.y + f.height);
    ctx.lineTo(f.x + f.width / 2, f.y);
    ctx.lineTo(f.x + f.width, f.y + f.height);
    ctx.closePath(); ctx.fill();

    if (colliding(player, f)) {
      score += 10;
      flasks.splice(i, 1);
      // Play pickup SFX
      pickupSFX.currentTime = 0;
      pickupSFX.play().catch(()=>{});
    }

    if (f.x + f.width < 0) flasks.splice(i, 1);
  });

  // Birds
  birds.forEach((b, i) => {
    b.x -= gameSpeed;
    ctx.fillStyle = "#f00";
    ctx.fillRect(b.x, b.y, b.width, b.height);
    if (colliding(player, b)) gameOver();
    if (b.x + b.width < 0) birds.splice(i, 1);
  });

  player.update();
  score++;
  document.getElementById("score").innerText = "Score: " + score;

  if (score >= 10000) winGame();
  else requestAnimationFrame(gameLoop);
}

// --- RESTART ---
function restartGame() { initGame(); }

// --- INPUT ---
document.addEventListener('keydown', e => {
  if (e.code === "Space" || e.code === "ArrowUp") player.jump();
});

// --- START ---
initGame();
</script>


<script src="crt-effects.js"></script>
</body>
</html>
